---
layout: post
section-type: post
title: Two Scoops of Django - chap2. 최적화된 장고 환경 꾸미기
category: django
tags: [ 'django' ]
published: false
---

## 2.1 같은 데이터베이스를 이용하라.
일반적으로 많은 개발자들이 범하는 실수가 자신의 로컬 개발 환경에서는 SQLite3를 이용하고 실제 운영 환경에서는 PostgreSQL(또는 MySQL)을 이용하는 것이다. 두 개의 다른 데이터베이스가 똑같이 작동한다는 가정하에 아래 데이터베이스를 이용할 때 나타날 수 있는 상황들이 있다.  

### 2.1.1 운영 데이터를 완전히 똑같이 로컬에서 구동할 수는 없다.
운영 환경 데이터베이스 엔진이 로컬 개발 환경 데이터베이스 엔진과 서로 다를 때, 로컬 환경에서 구동하기 위해 운영 환경 데이터베이스의 완벽한 복사본을 가져올 수 없다.  
물론 운영 데이터베이스에서 SQL 덤프를 해 와서 로컬 데이터베이스 환경에 이전 할 수는 있다. 하지만 그렇게 데이터베이스 익스포트와 임포트를 했다고 두 개의 데이터베이스가 완전히 같은 복사본의 데이터를 가지고 있다고 볼 수는 없다.

### 2.1.2 다른 종류의 데이터베이스 사이에는 다른 성격의 필드 타입과 제약 조건이 존재한다.
데이터베이스 종류가 다르면 각 필드 데이터 타입에 대해 저마다 다르게 작동한다. 장고 ORM은 이런 차이를 극복하려하지만 그러기엔 편차가 꽤 벌어져 있다.  
보통 SQLite3를 로컬 환경에서, 그리고 PostgreSQL을 운영 환경에서 이용할 때 장고 ORM이 이 두 데이터베이스 간의 차이에 대해 알아서 처리할 것이라고 생각하지만, 결국 SQLite3는 엄격한 타이핑이 아니라 동적이고 느슨한 파이핑을 지원하므로 문제가 생긴다.  
물론 장고 ORM이 코드가 SQLite3와 좀 더 엄격한 타입으로 서로 작용하게 해준다. 하지만 개발 환경에서 발생한 폼과 모델 사이의 문제는 운영 환경으로 가기 전까지는 발견되지 않으며(테스트를 통해서도 발견되지 않는다) 아마 복잡한 쿼리라도 로컬 환경에서 문제 없이 처리될 것이다. SQLite3는 엄격하게 규칙을 지키지는 않기 때문이다. 하지만 운영 환경으로 가면 PostgreSQL나 MySQL 데이터베이스가 로컬 환경에서는 전혀 본 적이 없는 제약 조건 에러(constraint error)를 뱉어 낼 것이다. 로컬 환경에 운영 환경과 같은 데이터베이스 엔진을 구축하기 전까지는 이 문제를 재현하는데 큰 어려움이 있을 것이다.  
대부분의 문제는 프로젝트가 개발 환경보다 더 엄격한 타입을 가지고 있는 데이터베이스에서 실행되기 전까지는 발견되기 어렵다.  

> #### 최고의 조합 = 장고 + PostgreSQL  
장고 개발자는 대부분 PostgreSQL를 선호한다. 개발, 스테이징, QA, 운영환경을 다 통틀어서 말이다.  
PostgreSQL는 경우에 따라 설치할 때 약간의 추가 작업이 필요로 할 수 있지만, 충분히 그럴만한 가치가 있는 데이터베이스 엔진이다.

### 2.1.3 픽스처는 마법을 부리지 않는다.
로컬 데이터베이스와 운영 데이터베이스 사이의 차이를 없애기 위해 필스처(fixture)를 사용하기도 한다. 피스처는 단순히 하드 코딩된 간단한 데이터 세트를 생성하는 데는 좋은 도구다. 때때로 개발 환경에서 이용하기 위해 운영 데이터베이스 환경에서 가짜 데이터 세트를 미리 추출할 필요를 느낄 때가 있다. 특히 개발 초기 단계에서 그렇다.  

하지만 픽스처는 한 데이터베이스 엔진에서 다른 데이터베이스 엔진으로 큰 크기의 데이터 세트를 이전하는 데는 그다지 신뢰할 만한 도구가 아니다. 도구 자체가 그런 목적으로 만들어 지지 않았기 때문이다. 픽스처의 기능을, 운영 환경의 데이터를 이전하기 위해 기본 데이터를 생성(dumpdata/loaddata)하는 데이터베이스 도구중 하나로 오해하면 안된다.

## 2.2 pip와 virtualenv 이용하기
pip는 파이썬 패키지 인덱스(Python Package Index)와 그 미러 사이트에서 파이썬 패키지를 가져오는 도구이다.  
virtualenv는 파이썬 패키지 의존성을 유지할 수 있게 독립된 파이썬 환경을 제공하는 도구다.  

pip는 파이썬 3.1.4 이후 버전부터는 파이썬에 기본으로 내장되어 있다.

![]({{site.url}}/img/post/django/two_scoops/2.1.png)

## 2.3 pip를 이용하여 장고와 의존 패키지 설치하기
장고 공식 문서는 다양한 장고 설치 방법을 설명하지만, pip와 requirements 파일을 이용하는 것이 가장 추천되는 방법이다.  
requirements는 설치하려는 파이썬 패키지에 대한 목록이 들어 있다.

> #### PYTHONPATH 설정하기  
virtualenv의 PYTHONPATH를 설정함으로써 django-admin.py를 여러 작업에 사용할 수도 있다.  
또한 virtualenv의 PYTHONPATH를 현재 디렉터리와 최신 버전의 pip를 포함하도록 설정하고, 현재 프로젝트의 최상위 디렉터리에서 'pip install -e .'를 실행하면, 현재 디렉터리에서 패키지를 수정 가능한 상태로 설치할 수 있다.  
설정 방법이 익숙하지 않다면 manage.py를 이용하면 된다.
- <http://hope.simons-rock.edu/~pshields/cs/python/pythonpath.html>
- <https://docs.djangoproject.com/en/1.11/ref/django-admin/>

## 2.4 버전 컨트롤 시스템 이용하기
버전 컨트롤 시스템은 리비전 컨트롤 또는 소스 컨트롤이라고 부르기도 한다.  
여러 도구 중에서 깃(Git)과 머큐리얼(Mercurial)이 장고 개발자들 사이에서는 일반적으로 널리 쓰인다. 깃과 머큐리얼 모두 브랜치를 생성하고 변견 사항을 병합하는 데 매우 편리한 기능을 제공한다.  
버전 컨트롤 시스템을 이용한 단순히 로컬 카피뿐만 아니라 백업을 위한 호스팅 서비스로도 이용할 수 있다. 깃허브와 비트버킷을 이용하면 된다.

## 2.5 선택 사항 : 동일한 환경 구성
개발자의 노트북에서 잘 작동하던 프로젝트가 운영환경에서는 제대로 작동하지 않을 수도 있다. 운영 환경과 정말 똑같은 개발 환경을 만들수도 있지만 만여 대의 서버를 구성하야 하는 등의 불가능 한 경우들도 있다. 그래서 '똑같은'이 아니아 '가능한 한 똑같이'한다.

- 서로 다른 운영 체제 : 개발은 맥이나 윈도우에서 이루어지고 운영 환경은 우분투 리눅스가 이용된다면, 장고 앱이 로컬에서 구동되는 것과 운영 환경에서 구동되는 것 사이에는 큰 차이가 있다.
- 서로 다른 파이썬 셋업 : 많은 개발자와 시스템 관리자들이 현재 사용하는 파이썬의 버전을 오판하거나 헷갈리는 경우가 있다. 파이썬을 제대로 설정하고 그 셋업을 완벽히 이해하는 것이 절대 쉬운 일이 아니기 때문이다.
- 개발자와 개발자 간의 차이 : 큰 규모의 팀에서는 개발자들 각각의 셋업 간 차이에서 오는 문제로 인해 디버깅에 많은 시간이 소비되기도 한다.

동일한 개발 환경 구성을 위해 가장 흔히 이용되는 방법에는 베이그런트(Vagrant)와 버추얼박스(VirtualBox)가 있다.

### 2.5.1 베이그런트와 버추얼박스
베이그런트는 재생산이 가능한 개발 환경을 생성, 설정, 관리하는데 쓰는 대중적인 도구다. 배이트그런의 큰 장점은 버추얼박스(또는 다른 VM 도구들)과 쉽게 연동된다는 점이다.  
개발용 노트북 컴퓨터가 OS X인데 반해 운영 프로젝트 설정은 우분투에 종속된 환경이라면 베이그런트와 프로젝트의 Vagrantfile을 이용하여 가상의 우분투 개발 환경을 로컬에서 빠르게 구성하고 프로젝트를 위한 모든 패키지 설치와 세팅을 빠르게 끝낼 수 있다.  

- 프로젝트 개발 팀원 모두에게 똑같은 개발 환경을 제공
- 생성된 로컬 개발 환경의 설정을 스테이징, 테스트, 운영 환경과 비슷하게 설정

반면 다음과 같은 단점이 있다.

- 대부분의 경우에는 필요하지 않는 기능들까지 제공되어 복잡성이 더해진다. 운영 체제 레벨까지 고려해야 할 필요가 없는 단순한 프로젝트의 경우엔 이러한 가상화 환경을 적용하지 않는 편이 더 편리하다.
- 구형 개발 기기들의 경우 가상 기기를 돌리는 것 자체가 큰 속도 저하를 가져온다. 구현 기기뿐 아니라 신형 기기라 할지라도 가상화 때문에 무시할 수 없는 정도의 부하가 발생한다.

> #### 도커 컨테이너를 이용하여 독립 환경 만들기  
도커를 이용하는 것은 VM에서 개발하는 것과 흡사하다. 단지 좀 더 가벼운 환경이라는 점 정도가 다르다. 도커 컨테이너는 호스트 운영 체제를 나눠 쓰는 것이지만 컨테이너 각각이 독립된 프로세스와 메모리 영역을 쓴다. 더 나아가 AUFS(advanced multi layered unification filesystem)를 이용하는 도커는 처음부터 빌드되는 게 아니라, 기존 스냅샷과 델타(변경된 내용)로부터 빌드되기 때문에 그 속도가 상당히 빠르다.  
이벤트브라이트(Eventbrite)의 아키덱처 팀은 VM의 프로비저닝 속도를 높이기 위해 도커와 베이그런트를 같이 이용하고 있다.

## 2.6 요약
pip, virtualenv, 버전 컨트롤 시스템은 장고 프로젝트 뿐 아니라 파이썬 소프트웨어 개발 전반에 걸쳐 일반적으로 이용되는 도구이기 때문에 반드시 익혀두어야 한다.
