---
layout: post
section-type: post
title: Two Scoops of django 3.x - Chap29. Logging. What's if for, anyway?
category: django
tags: [ 'django' ]
---

> [Two Scoops of Django 3.x](https://www.feldroy.com/books/two-scoops-of-django-3-x)
 
---

- 로깅(logging)
    - 서로 다른 로그 레벨을 적절히 사용
    - 모듈별 로거를 제작
    - 중요한 이벤트에 대한 정보를 꼼꼼하게 로깅
    - 이벤트를 로깅할 때 애플리케이션 상태에 대한 자세한 정보를 포함하는 것
    - 평소와 다른 부하를 안정적으로 처리하고 사이트 처리량을 쉽게 확장하는 비법 중 하나
    - 에러를 디버깅하거나 성능에 관련된 정보를 수집하는 역할
    - 평소와 다른 변화를 로그로 기록하고 주기적으로 로그를 확인하여 서버 보안에 사용

## 29.1 Application Logs vs. Other Logs

- 애플리케이션 로그: 애플리케이션에서 발생하는 데이터를 담은 파일들
- 서버 로그
- 데이터베이스 로그
- 네트워크 로그
- 상용 시스템의 상태를 보여주는 기타 모든 로그

모두 똑같이 다 중요함

## 29.2 Why Bother With Logging?

왜 Logging에 신경을 쓰는가?

- Logging: 스택 트레이스나 디버깅 도구로 충분한 정보를 얻지 못할 때 이용하는 도구
    - 독립적으로 움직이는 여러 모듈이 상호 연동된 상태에서 예상치 못한 상황을 발생시키는 부분들에 대해 로깅을 재빨리 분석하고 이해하도록 도움을 줌

## 29.3 When to Use Each Level

각 로그 레벨을 어떤 경우에 이용할 것인가?

- 레벨의 종류
    - DEBUG / INFO / WARNING / ERROR / CRITICAL

상용환경에서는  DEBUG 를 제외한 모든 레벨을 이용해야 합니다.

그 외의 레벨들은 상용 환경과 개발 환경 모두 동일한 로그가 기록됩니다.

즉, 환경 별로 로그를 분리하지 않아도 된다는 뜻입니다.

### 29.3.1 Log Catastrophes With CRITICAL

- CRITICAL:  무언가 심각한 참사가 일어날 만하여 급하게 주의를 요구될 때 이용
- Django 코어 코드에서는 사용되지 않음

### 29.3.2 Log Production Errors With ERROR

- ERROR: 코드에서 발생한 예외가 처리되지 않았을때 사용
- DEBUG를 False로 설정시 ADMINS에 등록된 모든 사람은 다음 내용을 이메일로 받게 됩니다.
    - 에러에 대한 설명
    - 에러가 발생한 시점에서 파이썬의 트레이스백 내용
    - 에러를 발생시킨 HTTP 요청 정보

### 29.3.3 Log Lower-Priority Problems With WARNING

- WARNING: 일반적이지 않은 문제를 초래할 가능성을 있지만, ERROR 레벨만큼 심각하지 않은 경우
- Django는 `CsrfViewMiddleware`의 여러 부분에서 403 Forbidden 에러 발생시 WARNING 레벨의 로그를 사용함
    - ex) POST 요청이 `csrf_token`을 포함하고 있지 않은 경우

### 29.3.4 Log Useful State Information With INFO

- INFO: 특별한 분석이 필요한 부분에 세부 정보를 남길때 이용
    - 다른 부분에서 로그를 남기지 않는 중요 컴포넌트의 시작과 종료
    - 중요한 이벤트에 대한 응답으로 일어난 상태의 변화
    - 권한 변화 시(일반 사용자가 어드민 권한을 획득했을 때)
- 성능에 대한 분석을 위한 일반적인 정보를 남기기에도 적합
- 문제가 되는 병목 지점을 발견하고 프로파일링하는데 좋음

### 29.3.5 Log Debug-Related Messages to DEBUG

- DEBUG: 개발 환경에서 디버깅을 목적으로 print문을 통해 로그를 남기고 싶을 때 사용

```python
# 나쁜 예
# 웹 서버의 종류에 따라 print 문이 사이트를 다운시킬 수도 있음
# print 문은 기록이 남지 않기 때문에, 로깅에서 놓칠 수도 있음
from django.views.generic import TemplateView 
from .helpers import pint_counter

class PintView(TemplateView):

    def get_context_data(self, *args, **kwargs):
        context = super().get_context_data(**kwargs) 
				pints_remaining = pint_counter()
				print(f'Only {pints_remaining} pints of ice cream left.') 
				return context
```

```python
# 좋은 예
import logging
from django.views.generic import TemplateView 
from .helpers import pint_counter

logger = logging.getLogger(__name__)

class PintView(TemplateView):

    def get_context_data(self, *args, **kwargs):
        context = super().get_context_data(**kwargs) 
        pints_remaining = pint_counter() 
        logger.debug('Only %d pints of ice cream left.' % pints_remaining) 
        return context
```

- 로깅은 각기 다른 레벨의 보고와 응답 메서드를 제공합니다.
    - DEBUG 레벨에서만 적용되는 로그를 이용할 수 있다.
        - 해당 코드가 상용 환경에 이용되어도 문제 없음
    - 응답 메서드는 이메일, 로그 파일, 콘솔,  `stdout` 형태로 이용될 수 있음
        - 센트리 같은 애플리케이션으로 HTTP 요청 푸시를 발생시킬 수도 있음

디버그 레벨의 로그를 너무 과용할 필요는 없습니다. `logging.debug()` 를 추가하는 건 문제 없지만, 매 라인마다 로그를 남길 필요는 없습니다.

## 29.4 Log Tracebacks When Catching Exceptions

예외를 처리할 때 트레이스백 로그 남겨두기

- 파이썬의 로깅 모듈 지원 기능
    - `Logger.exception()`은 ERROR 레벨에서 자동으로 트레이스백과 로그를 포함함
    - 다른 로그 레벨에 대해서는  `exec_info` 옵션 키워드를 이용할 수 있음

```python
# WARNING 로그 레벨에서 트레이스백을 남기는 예
import logging
import requests

logger = logging.getLogger(__name__)

def get_additional_data():
    try:
        r = requests.get('http://example.com/something-optional/') 
    except requests.HTTPError as e:
        logger.exception(e)
        logger.debug('Could not get additional data', exc_info=True) 
        return None
    return r
```

## 29.5 One Logger Per Module That Uses Logging

한 모듈당 한 개의 로거 쓰기

다른 모듈에서 로깅을 쓸 때 다른 곳의 로거를 임포트하여 재사용하지 말아야 합니다.

```python
# 새로은 로그를 모듈에 정의해서 사용하는 예
import logging
logger = logging.getLogger(__name__)
```

이렇게 하면 지금 필요로 하는 해당 로그에 대해 그 기능을  on/off 할 수 있습니다.

## 29.6 Log Locally to Rotating Files

로컬에 로그 남기기와 로그 파일 로테이션하기

- Django의 기본 설정
    - ERROR나 그 이상의 로그를 ADMINS 리스트에 지정되어 있는 사람에게 이메일로 발송
    - AdminEmailHandler를 통해 이루어짐
- INFO나 그 이상의 로그는 디스크에 저장해야 합니다.
    - 어떤 이유에서 네트워크가 제대로 작동하지 않거나, 어드민에게 이메일을 발송할 수 없을때 도움이 됨
    - 로그 로테이션(log rotation): 늘어나는 로그들이 디스크를 다 써버리는 것을 막아주는 기능을 제공함
        - 일반적으로 logging.handlers.WatchedFileHandler를 통해 유닉스 logrotate 유틸리티를 이용하는 방법을 사용
        - PaaS를 이용시 로그 파일 로테이션이 허용되지 않을 수도 있음
            - 로글리(loggly.com [https://www.loggly.com/](https://www.loggly.com/)) 같은 외부 로깅 서비스를 이용할 수 있음

## 29.7 Other Logging Tips

- Django 문서의 로깅 부분에 있는 세팅 파일에서 로그 컨트롤 하기
- 디버깅할 때는 파이썬 로거를 DEBUG 레벨로 세팅하여 이용하기
- DEBUG 레벨에서 테스트를 끝낸 후 해당 로그들을 INFO나 WARNING 레벨로 변경하기
- 로깅 기능을 더 늦기 전에 추가하기
- ERROR나 그 이상의 로그에 대해 이메일 받기
    - 페이저튜티([pagerduty.com](https://www.pagerduty.com/)) 같은 서비스는 해당 문제에 대해 어떤 조치가 이루어지기 전까지 지속적으로 팀원들에게 알람을 보내준다.
- logutils(by Vinay Sajip) 사용하기
    - 로그를 처리하는데 필요한 다양한 기능을 제공
        - 윈도우, 리눅스, 맥 OS에서 콘솔에 여러 색을 적용
        - 큐에 로그를 남길 수 있게 해 줌
            - SMTPHandler와 같이 시간이 걸리는 핸들러에 대해 로그를 큐로 설정해서 보낼 수 있게 함
        - 로그 메시지에 대해 단위 테스트를 할 수 있는 클래스를 지원
        - 암호화된 HTTPS를 지원하는 개선된 HTTPHandler를 제공

## 29.8 Necessary Reading Material

- [https://docs.djangoproject.com/en/3.2/topics/logging/](https://docs.djangoproject.com/en/3.2/topics/logging/)
- [https://docs.python.org/3/library/logging.html](https://docs.python.org/3/library/logging.html)
- [https://docs.python.org/3/library/logging.config.html](https://docs.python.org/3/library/logging.config.html)
- [https://docs.python.org/3/library/logging.handlers.html](https://docs.python.org/3/library/logging.handlers.html)
- [https://docs.python.org/3/howto/logging-cookbook.html](https://docs.python.org/3/howto/logging-cookbook.html)

## 29.9 Useful Third-Party Tools

유용한 서드 파티 도구들

- 센트리([Sentry](https://sentry.io/welcome/)): 에러를 수집해 주는 서비스를 제공
- 로글리([Loggly](https://www.loggly.com/)): 로그 관리를 쉽게 해주며, 훌륭한 쿼리 도구를 제공함
