---
layout: post
section-type: post
title: pyDjango - chap10. 실전 프로그램 개발 - Photo 앱
category: django
tags: [ 'django' ]
---
포토 앱은 사진들을 앨범으로 그룹화해 관리하고 각 사진에 대한 정보를 등록하고 열람할 수 있는 앱입니다.  

웹 사이트에 사진을 올리고, 그 사진들을 앨범으로 그룹화하고, 앨범 및 사진들을 열람할 수 있는 앱입니다. 사진의 썸네일을 처리하기 위해 새로운 커스텀 필드가 필요하므로, Pillow 라이브러리를 활용해서 커스텀 필드를 작성하는 방법을 다룹니다.

## 10.1 애플리케이션 설계하기
포토 앱에 필요한 테이블은, 사진을 담는 Photo 테이블과 사진들을 그룹화해 그 정보를 담을 수 있는 Album 테이블이 필요합니다. 또한 사진을 사이트에 등록하는 업로드 기능, 썸네일 사진을 생성하는 기능도 필요합니다.

### 10.1.1 화면 UI 설계

### 10.1.2 테이블 설계
Album 테이블과 Photo 테이블 2개가 필요한데, 두 테이블은 1:N 관계입니다. 즉, 하나의 앨범은 여러 개의 사진을 가질 수 있고, 하나의 사진은 하나의 앨범에만 속하는 관계입니다. 이 관계는 포토 테이블의 album 속성에 ForeignKey 필드로 지정됩니다.

- 포토 앱 - 테이블 설계(Album 모델 클래스)

필드명 | 타입 | 제약 조건 | 설명
---|---|---|---
id | Int | PK, Auto Increment | 기본 키
name | CharField(50) | | 앨범 제목
description | CharField(100) | Blank | 앨범에 대한 한 줄 설명

- 포토 앱 - 테이블 설계(Photo 모델 클래스)

필드명 | 타입 | 제약 조건 | 설명
---|---|---|---
id | Int | PK, Auto Increment | 기본 키
album | ForeignKey | FK(Albun.id) | Album에 대한 외래 키
title | CharField(50) | | 사진 제목
image | ThumbnailImageField | | 원본 및 썸네일 사진
description | TextField | Blank | 사진에 대한 설명
upload_date | DateTimeField | auto_now_add | 사진을 업로드한 일시

### 10.1.3 URL 설계

URL 패턴 | 뷰 이름 | 템플릿 파일명
---|---|---
/photo/ | AlbumLV(ListView) | album_list.html
/photo/album/ | AlbumLV(ListView) | album_list.html
/photo/album/99/ | AlbumDV(DetailView) | album_detail.html
/photo/photo/99/ | PhotoDV(DetailView) | photo_detail.html

### 10.1.4 작업/코딩 순서

작업 순서 | 관련 명령/파일 | 필요한 작업 내용
---|---|---
뼈대 만들기 | startapp <br> settings.py | 포토 앱을 생성 <br> 포토 앱을 등록
모델 코딩하기 | models.py <br> admin.py <br> fields.py <br> makemigrations <br> migrate | 모델(테이블) 정의 <br> Admin 사이트에 모델 등록 <br> ThumbnailImageField 커스텀필드 정의 <br> 모델을 데이터베이스에 반영
URLconf 코딩하기 | urls.py | URL정의
뷰 코딩하기 | views.py | 뷰 로직 작성
템플릿 코딩하기 | templates 디렉터리 | 템플릿 파일 작성
그 외 코딩하기 | static 디렉터리 | 사진 정렬을 위한 photo.css 추가

## 10.2 개발 코딩하기

### 10.2.1 뼈대 만들기

```
$ python manage.py startapp photo
```

settings.py 에 등록합니다.

```python
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'bookmark.apps.BookmarkConfig',
    'blog.apps.BlogConfig',
    'tagging.apps.TaggingConfig',
    'disqus',
    'django.contrib.sites',
    'photo.apps.PhotoConfig', # 추가
]
```
포토 앱에서는 사진을 업로드하는 기능이 필요합니다.

```python
# Media
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
```

### 10.2.2 모델 코딩하기
포토 앱은 Album과 Photo 두 개의 테이블이 필요합니다. Photo 테이블은 사진에 대한 정보를 담는 테이블이고, Album 테이블은 같은 주제의 사진들을 모으는 역할을 합니다.

#### models.py

- photo/models.py

```python
from django.db import models
from django.core.urlresolvers import reverse

from photo.fields import TunmbnailImageField # 1

# Create your models here.

class Album(models.Model):
    name = models.CharField(max_length=50)
    description = models.CharField('One Line Description', max_length=100, blank=True)

    class Mete:
        ordering = ['name']

    def __str__(self):
        return self.name

    def get_absolute_url(self): # 2
        return reverse('photo:album_detail', args=(self.id,))

class Photo(models.Model):
    album = models.ForeignKey(Album) # 3
    title = models.CharField(max_length=50)
    image = TunmbnailImageField(upload_to='photo/%Y/%m') # 4
    description = models.TextField('Photo Description', blank=True) # 5
    upload_date = models.DateTimeField('Upload Date', auto_now_add=True) # 6

    class Meta:
        ordering = ['title']

    def __str__(self):
        return self.title

    def get_absolute_url(self):
        return reverse('photo:photo_detail', args=(self.id,))
```

- 1 : ThumbnailImageField 필드 클래스는 사진에 대한 원본 이미지와 썸네일 이미지를 모두 저장할 수 있는 필드로, 직접 만들 커스텀 필드입니다.
- 2 : get_absolute_url() 메소드는 이 메소드가 정의된 객체를 지칭하는 URL을 반환합니다. 메소드 내에서는 장고의 내장 함수인 reverse() 를 호출합니다. 여기서는 /photo/album/99/ 형식의 URL을 반환합니다.
- 3 : album 컬럼은 Album 테이블에 연결된 외래 키입니다. 즉, 본 사진이 소속되 앨범 객체를 가리키는 reference 역할을 합니다.
- 4 : image 컬럼은 필드 타입이 ThumbnailImageField 입니다. ThumbnailImageField 필드는 사진에 대한 원본 이미지 및 썸네일 이미지 둘 다 저장할 수 있는 필드인데, upload_to 옵션으로 저장할 위치를 지정합니다. 'photo/%Y/%m'의 의미는 MEDIA_ROOT로 정의된 디렉터리 하위에 ~/photo/2017/09/ 처럼 연도와 월을 포함해 디렉터리를 만들고 그 곳에 업로드하는 사진의 원본 및 썸네일 사진을 저장합니다. 업로드 시점에 디렉터리가 없으면 자동으로 생성합니다.
- 5 : description 컬럼은 TextField 를 사용해 여러 줄의 입력이 가능합니다. 컬럼에 대한 레이블은 'Photo Description'이고 내용이 없어도 됩니다.
- 6 : upload_date 컬럼은 날짜와 시간을 입력하는 DateTimeField이며, auto_now_add 속성으로 사진이 업로드되는 시간을 자동으로 기록합니다.

> #### TagField vs ThumbnailImageField 커스텀 필드 정의  
커스텀 필드란 장고에서 기본으로 제공하는 필드가 아니라, 서드 파티에서 스스로 정의한 필드입니다. TagField 커스텀 필드는 django-tagging 패키지에 포함되어 있어서 패키지만 설치만 하면 사용할 수 있습니다. 반면 ThumbnailImageField 커스텀 플드는 별도의 패키지가 있는 것이 아니라 직접 코딩해야 하는 커스텀 필드입니다.

#### admin.py
Admin 사이트에 보이도록 admin.py 파일에 등록합니다. Admin 사이트의 모습을 정의하는 AlbumAdmin, PhotoAdmin 클래스도 정의합니다.

- photo/admin.py

```python
from django.contrib import admin
from photo.models import Album, Photo

# Register your models here.
class PhotoInline(admin.StackedInline): # 1
    model = Photo
    extra = 2 # 2

class AlbumAdmin(admin.ModelAdmin):
    inlines = [PhotoInline] # 3
    list_display = ('name', 'description')

class PhotoAdmin(admin.ModelAdmin):
    list_display = ('title', 'upload_date')

admin.site.register(Album, AlbumAdmin)
admin.site.register(Photo, PhotoAdmin)
```

- 1 : 외래 키로 연결된 Album, Photo 테이블 간에는 1:N 관계가 성립되므로, 앨범 객체를 보여줄 때 객체에 연결된 사진 객체들을 같이 보여줄 수 있습니다. 같이 보여주는 형식은 StackedInline과 TabularInline 두 가지가 있는데, StackedInline는 세로로 나열되는 형식을 보여줍니다. PhotoInline 클래스에서 이런 사항을 정의하고 있습니다. TabularInline은 테이블 모양처럼 행으로 나열되는 형식입니다.
- 2 : 이미 입력된 객체 외에 추가로 입력할 수 있는 Photo 테이블 객체의 수는 2개입니다.
- 3 : 앨범 객체를 보여줄 때 PhotoInline 클래스에서 정의한 사항을 같이 보여줍니다.

#### fields.py
#### 데이터베이스에 반영
