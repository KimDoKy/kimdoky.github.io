---
layout: post
section-type: post
title: Two Scoops of django 3.x - Chap32. Deployment. Platforms as a Service
category: django
tags: [ 'django' ]
---

> [Two Scoops of Django 3.x](https://www.feldroy.com/books/two-scoops-of-django-3-x)
 
---

규모가 작은 프로젝트나 스타트업에겐 PaaS는 많은 이득이 됩니다. 물론 규모가 커도 이득을 얻을 수 있습니다.

PaaS의 다양한 서비스로 다양한 서비스를 코드, 데이터베이스, 미디어 파일을 호스팅하게 됩니다.

이러한 서비스들은 제공하는 기능이나 성능면에서도 훌륭합니다.

하지만 PaaS는 급격한 가격 인산, 성능 퇴보, 힘든 계약 사항의 변경, 라이선스 관계 변경, 서비스 자원의 급격한 감소, 서비스 종료 등의 변수들이 있습니다.

PaaS에 종속이 되면 위와 같은 이듀들로 인해 다른 PaaS 회사로 이전하더라도 프로젝트의 주요 구성 자체를 변경하지 않고 이전할 수 있도록 해야 합니다.

- Django 지원 PaaS 업체
	- [DigitalOcean App Platform](https://try.digitalocean.com/app-platform/)
	- [PythonAnywhere](https://www.pythonanywhere.com/)
	- [Render](https://render.com/)
	- [Divio](https://www.divio.com/cloud-management)
	- [Zappa](https://github.com/miserlou/zappa)

## 32.1 Evaluating a PaaS

PaaS를 고르는 조건들을 살펴봅니다.

### 32.1.1 compliance
법적 제약

PaaS 시스템이 각 지역별, 국가별 법적 요구 조건을 충족하는지 확인해야 합니다.

- 법적 제약 예들
	- 미국 내의 의료 정보 기반 프로젝트들은 HIPAA(Health Insurance Portability and Accountability Act) 표준을 충족해야 합니다.
	- 전자 상거래 프로젝트는 최소한 SSL을 사용해야 하며 신용카드 정보 관련 처리를 하기 위해 PCI를 만족해야 합니다.
	- 유럽연합(EU)에서는 개인 식별이 가능한 데이터를 다룰 경우 해당 계정의 개인 정보 데이터를 보호하기 위한 유럽 연합 기준 95/46/EC를 따라야 합니다.

법률적으로 확실하지 않다면 법률 자문을 구할 수 있습니다.

### 32.1.2 Pricing
가격

많은 PaaS 업체들은 처음 시작하는 사용자나 토이 프로젝트를 위해 무료로 서비스를 제공합니다.

하지만 무료 서비스는 특정 조건 내에서만 제공하기 때문에 주의해야 합니다.

사이트에 많은 트래픽이 발생했을때 요금이 얼마나 나오는지도 미리 산정해봐야 합니다.

PaaS 업체에서 서비스 가격을 변경하는 것에 대해 법적, 도덕적 책임은 없습니다.

요금 폭탄을 맞지 않도록 항상 체크하고, 요금 시스템을 잘 알아봐야 합니다.

### 32.1.3 Uptime
가동 시간

업체는 서비스가 항상 제공되기를 원하지만 이는 다음과 같은 이유들로 어렵습니다.

- 많은 PaaS 업체는 AWS, Azure, GCP와 같은 업체로부터 공간을 빌려 이용합니다. 따라서 해당 업체에 문제가 생길 경우 많은 PaaS 업체도 똑같은 문제가 생깁니다.
- 모든 시설은 물리적 인프라스트럭처에 기반들 울 인터넷에 존재합니다. 자연재해 등으로 중지될 수도 있습니다.

 PaaS 업체의 핵심과제는 높은 수준의 안정성을 가진 서비스를 공급하는 것입니다. 대부분의 PaaS 업체는 높은 수준의 가동 시간을 제공하고 있고, 지속적으로 시스템 개선을 하고 있습니다. 신뢰할 만한 업체들은 서비스 정지와 문제점들에 대한 보고서도 제공하며, 시스템 상태를 모니터할 수 있는 페이지들도 제공합니다.
 
 최근 여러 번 서비스 정지 보고가 있거나 허용 범위를 초과한 긴 시간의 서비스 정지 사고가 있었다면 다른 PaaS 업체를 고려해봐야 합니다.
 
 매우 높은 수준의 가용성(ex. 사람의 생명이 연관된)을 필요로하는 프로젝트라면 PaaS 보다는 일반적인 사용자 이용 약관을 제공하는 인프라스트럭처 서비스를 이용해야 합니다.

### 32.1.4 Staffing
PaaS 회사의 인력 배치

PaaS 회사가 얼마나 높은 수준의 인력 배치가 가능한지 알아두어야 합니다.

-  PaaS 회사가 충분한 인력을 확보하고 있지 않다면 24x7의 엔지니어링 지원을 제공할 수 없을 것입니다. 특히 연휴나 명절에 그러합니다. 회사의 기술력이나 직원들의 열의와는 상관없이 스태프들이 잠들어 있는 도중에 발생한 문제를 해결해 줄 수 없을 것입니다.
-  이메일이나 이슈 티켓 대응 전담 인력의 여부도 체크해야 합니다. 엔지니어들이 직접 관리하고 있다면 해당 PaaS 업체의 발전 가능성은 낮다고 볼 수 있습니다.

PaaS 업체를 선택하기 전에 지원 티켓을 직접 만들어서 해당 PaaS 업체의 지원 수준을 테스트해 볼 수 있습니다. 해당 PaaS 업체의 문서에서 명확하게 다루지 않은 부분이나 업체로부터 도움이 필요로 하는 부분에 대해 심도 있는 질문으로 티켓을 만드는 방법도 있습니다.

### 32.1.5 Scaling
스케일링

얼마나 쉽게 빠르게 스케일 업/다운 할 수 있는지, 이러한 프로세스를 자동화할 수 있는지 확인해야 합니다.

### 32.1.6 HTTP Server

대부분의 PaaS 업체는 Nginx나 자체 유사 시스템으로 WSGI를 처리할 수 있어서 파이썬 친화적으로 사용할 수 있지만, 일부 PaaS 업체는 WSGI만 지원해서 Django Channel을 사용할 수 없습니다. 예를 들어 Zappa는 AWS API 게이트웨이의 웹소켓 구성 요소를 사용하지 않습니다. 그것은 아리아드네에서 Django Channel을 지원하거나 그래프QL 구독을 사용할 수 없다는 뜻입니다. 비동기 작업을 위해 비웹소켓 비동기 작업을 지원합니다.
- https://github.com/Miserlou/Zappa#asynchronous-task-execution

### 32.1.7 Documentation
문서화

쉽게 검색 가능한 참고 자료를 제공한다는 것은 매우 중요할 뿐만 아니라, PaaS 업체가 자신들의 업무를 얼마나 진지하게 생각하는지 나타내는 증거입니다.

### 32.1.8 Performance Degradation
성능저하?

잘 작동하던 프로젝트가 갑자기 느려지는 경우, 다음의 절차대로 문제를 짚어 볼 수 있습니다.

- 성능이 저하될 만한 변경 사항이 커밋되었는지 이력을 확인해 본다. 큰 버그가 숨어 있을 수도 있다.
- 발견되지 않은 병목 현상을 조사해본다. [Chap26. Finding and Reducing Bottlenecks]() 참고
- PaaS 지원팀에 해당 문제를 질문한다. 때론 지원팀이 빠른 대응을 할 수도 있다.
- 프로젝트가 구동되고 있는 물리적 하드웨어의 문제일 수도 있다. 새로운 인스턴스를 띄우고 데이터를 이전한 후 문제가 해결되었다면 해당 설정에 맞게 DNS를 업데이트한다.
- PaaS 지원팀에 좀 더 자세한 도움을 요청한다. 도움을 요청한다고 손해 볼 것은 없다. 특히 유료 고객이라면 더욱 도움을 요청하는데 주저해서는 안된다.

위 방법으로도 해결이 되지 않는다면 다른 PaaS 업체에 구동하거나 로컬 서버에서 구동해 볼 수 있습니다. 전혀 다른 환경에서 잘 작동한다면 시스템을 이전할 때가 되었다는 뜻입니다.

### 32.1.9 Geography
지기적 요건

PaaS 서비스가 위치한 지리적 위치와 서비스하게 될 장소를 고려해야 합니다. 당연히 각각의 지역이 멀리 떨어져 있다면 네트워크 지연 이슈가 발생할 것입니다.

### 32.1.10 Company Stability
회사의 안정성

PaaS 서비스를 한다는 것은 많은 어려움들이 있습니다.
많은 자본(엔지니어, 서버, 고객 응대, 회계, 마케팅 등의 사업 경비)이 필요한 사업입니다.
판매 부진, 펀징 이상의 지출, 과하게 달려온 스태프들의 탈진 등의 이유로 여러 PaaS 업체들이 실패했습니다.

따라서 PaaS 업체를 고려할 때 가격 정책을 유심히 살펴봐야 합니다. PaaS 업체가 베타 기간이나 초기 시작 시간이 지났는데도 이익을 낼 수 없다면 해당 PaaS 업체를 이용하는 것은 위험합니다.

## 32.2 Best Practices for Deploying to PaaS

### 32.2.1 Airn for Identical Environments
동일한 환경을 목표로 잡는다

배포의 핵심은 개발환경과 상용환경을 똑같이 맞추는 것입니다.
하지만 PaaS를 이용하는 순간 상용환경의 시스템 설정은 우리의 범위 밖의 일이 됩니다.
그럼에도 불구하고 가능한 한 개발환경과 상용환경을 최대한 동일하게 유지하여 프로젝트를 관리해야 합니다.

최선의 방법은 로컬 환경에서 도커를 통해 리눅스를 돌려보는 것입니다.

### 32.2.2 Maintain a Staging Instance
스테이징 인스턴스 관리하기

자동화를 하면 프로젝트의 스테이징 서버를 저렴한 서비스 레벨에서 쉽게 구성할 수 있습니다.
스테이징 환경은 상용환경에서의 배포를 테스트할 수 있는 최적의 장소이고, 기능 변경에 따른 데모 환경으로도 훌륭합니다.

### 32.2.3 Automate All the Things!
모든 것을 자동화하기

상용 인스턴스에 업데이트를 푸시할 때 모든 단계를 수동을 하면 실수를 하기 쉽기 때문에 자동화를 해야 합니다.

- Makefiles는 간단한 프로젝트에 유용합니다. 기능이 제한되어 있어 복잡한 시스템을 꾸미는 것을 방지해 줍니다.
- Invoke는 Fabric의 대를 잇는 도구입니다. Fabric과 매우 비슷하지만 원격 서버가 아닌 로컬 환경에서 태스트를 실행하는 기능이 있습니다. 태스크들은 파이썬 코드로 정의되어 있고 복잡한 구성도 구현할 수 있습니다.

### 32.2.4 Multiple Requirements Files in Multiple Environments

대부분의 PaaS는 루트의 requirements만 읽도록 제한합니다. 항상 동일한 환경으로 제한하는 것이 좋을 수 있지만, 때로는 다른 버전의 소프트웨어가 필요할 때도 있습니다.

스테이징에서 다른 버전의 소프트웨어로 배포하려하는 경우,  requirements.txt 대신 Makefile을 사용할 수 있습니다.

```
# Makefile
   deploystaging:
      echo -r requirements/staging.txt > requirements.txt
      git commit -am "Requirements change for staging deployment"
      echo -r requirements/production.txt > requirements.txt
      git commit -am "Change back to production requirements"
```

### 32.2.5 Prepare for Disaster With Backups and Rollbacks
백업과 롤백으로 장애 대비하기

앞서 본 주의사항들에도 불구하고 배포로 인해 모든 것을 날릴 위험성이 있습니다.

- 백업으로부터 데이터베이스와 사용자 업로드 파일들의 복구
- 이전 코드 푸시로 롤백

변경사항들을 서버에 반영하기 전에 PaaS 시스템에서 위의 기능들을 어떻게 이용할 수 있는지 알고 있어야 합니다.

### 32.2.6 Keep External Backups
외부 백업 유지하기

일부 PaaS는 백업을 생성하는 기능을 제공하는데, 여기에 외부 서비스로 주기적인 백업을 하는 것을 고려해봐야 합니다.
백업에는 데이터베이스 파일과 사용자가 올린 이미지들이 포함되어야 합니다.

Digital Ocean, AWS S3, Google Files, Azure Files 등의 외부 서비스에 데이터를 보관할 수 있습니다.
서비스 선택 기준은 아키텍처에 달려있는데, PaaS 서비스의 지역들이 고려 대상이 될 것입니다.
