---
layout: post
section-type: post
title: pyDjango - chap13. 실전 프로그램 개발 - 콘텐츠 편집 기능(Photo 앱)
category: django
tags: [ 'django' ]
---
포토 앱은 Album과 Photo 2개의 테이블이 있어 각각 콘텐츠 편집 기능이 필요합니다. Album과 Photo 테이블이 1:N 관계로 연결되어 있어, 생성이나 수정 폼 화면에서 이런 관계가 어떻게 구현되는지 이해하는 것이 중요합니다.

- 콘텐츠에 대한 열람은 모든 사용자가 가능하다.
- 콘텐츠를 새로 생성하는 것은, 로그인한 사용자만 가능하다.
- 콘텐츠를 수정 또는 삭제하는 작업은 그 콘텐츠를 생성한 사용자만 가능하다.

## 13.1 애플리케이션 설계하기
포토 앱의 2개 테이블, Album과 Photo  테이블에 대한 생성(Create), 수정(Update), 삭제(Delete) 기능을 구현하는 것이 핵심입니다. 또한 앨범 정보와 사진 정보를 동시에 입력받을 수 있는 인라인 폼셋을 구현하는 것도 필요합니다.

### 13.1.1 화면 UI 설계
pass

### 13.1.2 테이블 설계
각 콘텐츠에 대한 소유자를 지정할 수 있도록 Album과 Photo 테이블에 owner 필드가 추가되도록 설계합니다.

필드명 | 타입 | 제약 조건 | 설명
---|---|---|---
id | int | PK, Auto Increment | 기본 키
name | CharField(50) | | 앨범 이름
description | CharField(100) | Blank | 앨범 설명
owner | ForeignKey(User) | Null | 앨범 소유자
Album 모델 클래스

필드명 | 타입 | 제약 조건 | 설명
---|---|---|---
id | int | PK, Auto Increment | 기본 키
album | ForeignKey(Album) | | 사진이 소속된 앨범
title | CharField(50) | | 사진 제목
image | ThumbnailImageField | | 이미지 파일
description | TextField | Blank, NotNull | 사진 설명
upload_date | DateTimeField | auto_now_add | 사진을 업로드한 시각
owner | ForeignKey(User) | Null | 사진 소유자
Photo 모델 클래스

### 13.1.3 URL 설계
생성(add), 변경(change) 대상 리스트, 수정(update), 삭제(delete) URL을 추가해 설계합니다.

URL 패턴 | 뷰 이름 | 템플릿 파일명
---|---|---
/photo/ | AlbumLV(ListView) | album_list.html
/photo/album/ | AlbumLV(ListView) | album_list.html
/photo/album/99/ | AlbumDV(DetailView) | album_detail.html
/photo/photo/99/ | PhotoDV(DetailView) | photo_detail.html
/album/add/ | AlbumPhotoCV(CreateView) | album_form.html
/album/change/ | AlbumChangeLV(ListView) | album_change_list.html
/album/99/update/ | AlbumPhotoUV(UpdateView) | album_form.html
/album/99/delete/ | AlbumDeleteView(DeleteView) | album_confirm_delete.html
/photo/add/ | PhotoCreateView(CreateView) | photo_form.html
/photo/change/ | PhotoChangeLV(ListView) | photo_change_list.html
/photo/99/update/ | PhotoUpdateView(UpdateView) | photo_form.html
/photo/99/delete/ | PhotoDeleteView(DeleteView) | photo_confirm_delete.html

### 13.1.4 작업/코딩 순서

작업 순서 | 관련 명령/파일 | 필요한 작업 내용
---|---|---
모델 코딩하기 | models.py <br> migrate | owner 필드 추가 <br>  변경 사항을 데이터베이스에 반영
URLconf 코딩하기 | urls.py | URL 정의
뷰 코딩하기 | forms.py <br> views.py | 인라인 폼셋 정의 <br> 뷰 로직 작성
템플릿 코딩하기 | templates 디렉터리 | 템플릿 파일 작성
그 외 코딩하기 | templates 디렉터리 | homr.html 수정

## 13.2 개발 코딩하기
콘텐츠별로 소유자 속성을 추가하고 장고에서 제공하는 제네릭 뷰를 사용해서 콘텐츠 편집 기능을 구현합니다.

### 13.2.1 뼈대 만들기
pass

### 13.2.2 모델 코딩하기
Album과 Photo 테이블에 owner 필드를 추가합니다

- photo/models.py

```python
from django.db import models
from django.core.urlresolvers import reverse

from photo.fields import ThumbnailImageField

from django.contrib.auth.models import User # 추가

# Create your models here.

class Album(models.Model):
    name = models.CharField(max_length=50)
    description = models.CharField('One Line Description', max_length=100, blank=True)
    owner = models.ForeignKey(User, null=True) # 추가

    class Mete:
        ordering = ['name']

    def __str__(self):
        return self.name

    def get_absolute_url(self):
        return reverse('photo:album_detail', args=(self.id,))

class Photo(models.Model):
    album = models.ForeignKey(Album)
    title = models.CharField(max_length=50)
    image = ThumbnailImageField(upload_to='photo/%Y/%m')
    description = models.TextField('Photo Description', blank=True)
    upload_date = models.DateTimeField('Upload Date', auto_now_add=True)
    owner = models.ForeignKey(User, null=True) # 추가

    class Meta:
        ordering = ['title']

    def __str__(self):
        return self.title

    def get_absolute_url(self):
        return reverse('photo:photo_detail', args=(self.id,))
```

Album과 User 테이블 간 관계 및 Photo와 User 테이블 간 관계는 모두 N:1 관계이므로, ForeignKey 관계로 표현합니다. 또한 owner 필드는 Null 값을 가질 수 있도록 정의합니다.  

모델의 변경 사항을 데이터베이스의 테이블에 반영합니다.

```
$ python manage.py makemigrations
Migrations for 'photo':
  photo/migrations/0002_auto_20170922_1633.py
    - Add field owner to album
    - Add field owner to photo
(pyDjango) ------------------------------------------------------------
$ python manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, blog, bookmark, contenttypes, photo, sessions, sites, tagging
Running migrations:
  Applying photo.0002_auto_20170922_1633... OK
```
