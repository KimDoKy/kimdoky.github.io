---
layout: post
section-type: post
title: crawling - P2. 고급 스크레이핑 _ chap 11. 이미지 처리와 텍스트 인식
category: python
tags: [ 'python' ]
---

구글의 자율주행 자동차부터 위조지폐 인식하는 자판기까지, 컴퓨터에 눈을 다는 방대한 작업은 우리에게 큰 영향을 미치는 분야입니다. 이번 챕터에서는 이 분야의 작은 일부인 텍스트 인식에 집중합니다. 그중에서도, 온라인에서 가져온 텍스트 기반 이미지를 다양한 파이썬 라이브러리로 인식하고 사용하는 방법에 대해 다룹니다.  

텍스트 대신 이미지를 쓰는 건 봇이 텍스트를 읽는 것을 막기위해 사용하는 방법 중 하나입니다. 연락처에서 이메일 주소나 전체부분을 이미지 처리된 경우들이 있습니다. 정교하게 처리하면 사람조차도 이미지인지 텍스트인지 구분하기 어렵고, 봇은 그런 이미지 때문에 스팸을 뿌려대는 사람들로부터 이메일 주소를 보호할 수 있습니다.  

자동 가입 방지 문자(CAPTCHA) 역시 사용자가 보안 이미지를 읽을 수 있지만 대부분의 못은 읽지 못한다는 점을 이용합니다.  

하지만 웹 스크레이퍼가 이미지를 텍스트로 인식해야 하는 분야는 CAPTCHA만이 아닙니다. 최근에는 문서를 그냥 스캔해서 업로드 하는 경우가 많습니다. 이런 문서는 인터넷이라는 관점에서 보기엔 접근이 불가능한 것이나 마찬가지입니다. 이미지를 텍스트로 인식하는 기능이 없다면 이들 문서에 접근할 수 있는 방법은 사람이 손으로 타이핑하는 것 뿐입니다.  

이미지를 텍스트로 바꾸는 작업을 **광학 문자 인식(OCR)** 이라고 합니다. OCR 기능이 있는 주요 라이브러리는 그리 많지 않지만, 이들을 지원하거나 이들을 기반으로 만들어진 라이브러리는 여러가지입니다.

## 11.1 라이브러리 개관

파이썬은 이미지 처리와 읽기, 이미지 기반 머신 러닝, 심지어 이미지 생성에도 매우 뛰어난 언어입니다. 이미지 처리에 사용할 수 있는 라이브러리는 다양하지만, 이번 챕터에서는 필로(pillow)와 테서랙트(tesseract) 두 가지만 사용합니다.

### 11.1.1 필로

필로는 가장 많은 기능을 갖춘 이미지 처리 라이브러리는 아니지만, 파이썬으로 포토샵 같은 것을 만들거나 연구할 목적이 아닌 이상 필로정도면 충분합니다. 문서화도 잘 되어 있고, 사용하기도 쉽습니다.  

설치는 pip를 통해 하면 됩니다.

```
pip install pillow
```

필로는 파이썬 2.x용 파이썬 이미지 라이브러리인 PIL에서 갈려져 나와 파이썬 3.x 지원을 추가했습니다. PIL과 마찬가지로, 필로도 쉽게 이미지를 불러오고 조작하고, 다양한 필터와 마스크, 픽셀 단위 변형도 가능합니다.


```python
from PIL import Image, ImageFilter

kitten = Image.open("kitten.jpg")
blurryKitten = kitten.filter(ImageFilter.GaussianBlur)
blurryKitten.save("kitten_blurred.jpg")
blurryKitten.show()
```

위 코드는 kitten.jpg 이미지에 블러 효과를 추가해 기본 이미지 뷰어에서 열고, 동시에 kitten_blurred.jpg 라는 이름으로 저장합니다.  

필로는 이런 단순한 기능 외에도 많은 기능이 있습니다. 자세한 정보는 [문서](http://pillow.readthedocs.io/en/4.2.x/){:target="`_`blank"}를 참고합니다.

### 11.1.2 테서랙트

테서랙트는 OCR 라이브러리입니다. 테서랙트는 OCR과 머신 런닝으로 유명한 구글의 투자를 받고 있는데, 가장 정확한 최고의 오픈 소스 OCR 시스템으로 널리 인정받고 있습니다.  

테서랙트는 정확할 뿐 아니라 굉장히 유연합니다. 테서랙트는 폰트가 비교적 일관적이기만 하면, 숫자에 제한 없이 그 폰트를 인식하도록 훈련할 수 있으며, 유니코드 문자도 인식하도록 확장이 가능합니다.  

테서랙트는 import 문으로 불러오는 라이브러리가 아니라 파이썬으로 작성된 CLT(command line tool)입니다. 설치를 마치면 반드시 파이썬 명령행 외부에서 tesseract 명령어로 실행해야 합니다.

#### 테서랙트 설치

설치는 홈브류로 설치하면 됩니다.

```
brew install tesseract
```

테서랙트를 훈련시키는 것 같은 일부 기능은 데이터 파일(.traineddata 확장자)이 필요하며, 데이터 파일은 테서랙트 설치 위치 아래 tessdata 디렉터리에 위치해야 합니다.
> 데이터 파일을 따로 내려받지 않았다면 https://github.com/tesseract-ocr/tessdata 에서 직접 내려 받아야 합니다.

환경에 따라 테서랙트 설치 위치를 지정하는 환경 변수 `$TESSDATA_PREFIX`를 설정해야 할 수도 있습니다. 필요하다면 대부분의 리눅스와 맥 OS X에서는 아래 명령을 이용하면 됩니다.

```
$export TESSDATA_PREFIX=/usr/local/share/
```

`/usr/local/share/`는 테서랙트의 기본 설치 위치입니다.

### 11.1.3 넘파이

단순한 OCR에서는 필요하지 않지만, 테서랙트가 사용할 다른 문자나 폰트도 인식하도록 훈련하려면 넘파이(NumPy)가 필요합니다. 넘파이는 선형 대수학이나 기타 대규모 수학 애플리케이션에 사용하는 매우 강력한 라이브러리입니다. 넘파이는 이미지를 수학적인 거대한 픽셀 배열로 표현하고 조작할 수 있는데, 테서랙트에서 이런 기능을 활용할 수 있습니다. 물론 여기에서는 거기까지 사용하지 않습니다.

넘파이도 pip로 설치하면 됩니다.

```
pip install numpy
```

## 11.2 형식이 일정한 텍스트 처리

텍스트사 형식이 일정하다고 하려면 다음의 조건을 갖추어야 합니다.

- 표준 폰트 하나로 작성되어야 한다. 손으로 쓴 글씨, 필기체, 지나치게 장식적인 폰트는 제외합니다.
- 복사하거나 사진을 찍었다면 행 구분이 명료해야 하며, 복사로 인한 열화 현상이나 심하게 어두워진 부분이 없어야 합니다.
- 수평으로 잘 정렬되어 있어야 하며, 기울어진 글자가 없어야 합니다.
- 텍스트가 이미지를 벗어나거나, 이미지 모서리에 잘려서는 안 됩니다.

이런 조건 중 일부는 전처리를 통해 해결할 수 있습니다. 예를 들어 이미지를 그레이스케일로 바꾸고, 밝기와 명암을 조절하고, 필요 없는 부분을 잘라내거나 회전할 수 있습니다. 하지만 근본적인 한계는 있습니다.

![]({{site.url}}/img/post/python/crawling/c11_2_1.png)
위 이미지는 형식이 일정한 텍스트의 이상적인 예입니다.  

테서랙트를 실행해 이 이미지 파일을 읽고 결과를 텍스트 파일로 저장한 다음, 해당 텍스트 파일을 화면에 출력하는 명령입니다.

```
$ tesseract text.tif textoutput | cat textoutput.txt
```

출력 결과는 테서랙트가 실행 중임을 알리는 한 줄과 새로 만든 textoutput.txt의 내용입니다.

```
This is some text, written in Arial, that will be read by
Tesseract. Here are some symbols: !@#$%"&‘()

Tesseract Open Source OCR Engine v3.05.01 with Leptonica
```

기호 일부가 잘못 인식되긴 했지만, 결과는 거의 정확합니다. 일반적으로 텍스트 인식에 만족할 수 있을 정도입니다.  

이미지 텍스트에 블로 효과를 적용하고 JPG 압축으로 인한 열화가 생기게 하고, 배경에 그레이디언트를 추가하면 결과는 훨씬 나빠집니다.

![]({{site.url}}/img/post/python/crawling/c11_2_2.png)
> 인터넷에서 만나는 대부분의 이미지는 이런 이미지일 가능성이 높습니다.

테서랙트는 이 이미지를 이전 이미지만큼 잘 처리하지 못합니다. 주된 이유는 배경의 그레디언트 때문입니다.

```
This Is some text, wrmen In Aﬂll, ..
Tesseract Here are some symbdsz-

Tesseract Open Source OCR Engine v3.05.01 with Leptonica
```

배경의 그레이디언트가 텍스트를 구별하기 어렵게 하는 지점에 다다르자 텍스트가 잘렸습니다. 각 행의 마지막 글자도 틀렸는데, 테서랙트는 이 글자를 인식하려 했지만, 실패했습니다. JPG 열화와 블러 효과도 테서랙트가 소문자 i와 대문자 I, 숫자 1을 구분하기 어렵게 만듭니다.  

파이썬 스크립트로 이미지를 깔끔하게 만들면 도움이 됩니다. 필로 라이브러리로 임계점(threshold) 필터를 만들어 배경의 회색을 제거해서 텍스트가 잘 드러나게 하면 테서랙트가 이미지를 인식하기 쉬워집니다.

```python
from PIL import Image
import subprocess

def cleanFile(filePath, newFilePath):
    image = Image.open(filePath)

    # 회색 임계점을 설정하고 이미지를 저장합니다.
    image = image.point(lambda x: 0 if x<143 else 255)
    image.save(newFilePath)

    # 새로 만든 이미지를 테서랙트로 읽습니다.
    subprocess.call(["tesseract", newFilePath, "output"])

    # 결과 텍스트 파일을 열어 읽습니다.
    outputFile = open("output.txt", 'r')
    print(outputFile.read())
    outputFile.close()

cleanFile("text_2.tif", "text_2_clean.png")
```
자동으로 생성된 결과 이미지 `text_2_clean.png`입니다.

![]({{site.url}}/img/post/python/crawling/c11_2_1_text_2_clean.png)

문장부호 일부가 사라지거나 읽기 어렵게 되었지만, 텍스트는 최소한 사람의 눈으로 읽을 수 있는 수준입니다. 테서랙트 역시 훨씬 나은 결과를 보입니다.

```
This Is some text. written In Anal, that will be read
Tesselact Here are some symbols: !@#$%"&'0
```

마침표와 쉼표는 아주 작아서 이렇게 이미지를 이리저리 변형하다보면 사람에게나 테서랙트에게는 안보이게 됩니다. Arial를 Anal로 잘못 인식하기도 했는데, 그런 r,i를 n 한 글자로 인식했기 때문입니다.  

그래도 텍스트의 거의 반이 날아간 이전 버전보다는 개선되었습니다.  
테서랙트의 가장 큰 약점은 밝기가 일정치 않은 배경입니다. 테서랙트의 알고리즘은 텍스트를 읽기 전에 자동으로 명암을 조절하려 시도하지만, 필로 라이브러리 같은 도구로 직접 처리하는 것이 더 나은 결과를 보여줍니다.  
기울어진 이미지나 텍스트가 없는 영역이 넓은 이미지, 기타 다른 문제를 가진 이미지는 테서랙트로 읽기 전에 먼저 조정하는 것이 좋습니다.

### 11.2.1 웹사이트 이미지에서 텍스트 스크레이핑하기

## 11.3 CAPTCHA 읽기와 테서랙트 훈련

### 11.3.1 테서랙트 훈련

## 11.2 CAPTCHA 가져오기와 답 보내기
