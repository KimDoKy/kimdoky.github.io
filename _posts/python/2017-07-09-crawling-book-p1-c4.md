---
layout: post
section-type: post
title: crawling - P1.스크레이퍼 제작 _ cahp 4. API 사용
category: python
tags: [ 'python' ]
---

대형 프로젝트를 다루다 보면 다른 사람들의 코드를 다루면서 고생을 하게 됩니다. 네임스페이스 문제, 타입 문제, 함수 반환 값에 대한 오해, A 지점에서 B 메서드로 정보를 전달하는 것 같은 단순한 문제조차 악몽처럼 복잡해 질 수 있습니다.  

그래서 애플리케이션 프로그래밍 인터페이스(API)가 필요한 것입니다. API는 본질에서 다른 여러 애플리케이션 사이에 간편한 인터페이스를 제공합니다. 애플리케이션을 어떤 프로그래머가 만들었든, 어떤 구조로 만들었든, 심지어 언어가 무엇인지도 상관없습니다. API는 서로 정보를 공유해야 하는 소프트웨어 사이에서 국제어 구실을 하도록 디자인 된 것입니다.  

소프트웨어 애플리케이션이 다양하므로 API 역시 다양하지만, 최근에 API라고 하면 보통 웹 애플리케이션 API로 이해합니다. API가 요청을 보낼 때는 HTTP를 통해 데이터를 요청하며 API는 이 데이터를 XML이나 JSON 형식으로 반환합니다. 대부분의 API가 아직 XML을 지원하지만 JSON을 인토딩 프로토콜로 선택라는 API도 빠르게 늘어나고 있습니다.  

API를 사용하는 건 웹 스크레이핑이 아니라고 생각할 수도 있지만, 거의 같은 테크닉(HTTP 요청 보내기)을 사용해 비슷한 결과(정보 얻기)를 추구합니다. 둘은 상호 보완적일 때가 많습니다.  

예를 들어 웹 스크레이퍼에서 얻은 정보와 API에서 얻은 정보를 결합해 더 유용한 것으로 바꿀 수도 있습니다. 후반부에서 위키백과 편집 내역(IP 주소가 들어 있는)과 IP 주소 해석기 API를 결합해 세계 곳곳에 있는 위키백과를 어떻게 편집하고 있는지 알아보는 프로그램을 만듭니다.  

chap4 에서는 API의 일반적인 개관과 함께 최근 널리 쓰이는 API에 대해 알아보고, 직접 만든 웹 스크레이퍼에서 어떻게 활용할 수 있는지 살펴봅니다.


## 4.1 API는 어떻게 동작하는가

API는 원래 의도만큼 사방에서 쓰이지는 않지만, 다양한 정보에 필요한 API가 존재합니다. 음악과 음악가, 앨범, 음악 스타일과 관련된 정보를 얻을 수 있는 API도 있고, ESPN에서 선수 정보, 게임 정보, 점수 등 여러정보들에 관한 API를 제공합니다. 구글 개발자 섹션(https://console.developers.google.com)에는 언어 번역과 분석, 지오로케이션 등 수십 가지 API가 있습니다.  

API는 사용하기 매우 쉽습니다. 브라우저에 다음을 입력하는 것만으로 간단한 API 요청을 해볼 수 있습니다.

```
http://freegeoip.net/json/50.78.253.58
# 이 API는 IP 주소를 지리적 위치로 변환하는 API입니다.
```
다음과 같은 응답을 얻습니다.

```
{"ip":"50.78.253.58","country_code":"US","country_name":"United States","region_code":"MA","region_name":"Massachusetts","city":"Boston","zip_code":"02116","time_zone":"America/New_York","latitude":42.3496,"longitude":-71.0746,"metro_code":506}
```

API는 HTTP를 통해 동작합니다. 웹사이트에서 데이터를 가져오고, 파일을 내려받고, 기타 인터넷에서 하는 거의 모든 일과 똑같은 프로토콜입니다. API가 일반 웹사이트와 다른 점은 완전히 정형화된 문법을 사용한다는 점, HTML이 아니라 JSON이나 XML로 데이터를 보낸다는 점뿐입니다.

## 4.2 공통 표기법

API는 상당히 표준화된 규칙으로 정보를 제공하며, 그 정보를 생성하는 방법 역시 상당히 표준화되어 있습니다. 덕분에 API가 잘 만들어져 있다면 그 API를 사용하는데 필요한 기초적인 규칙을 빨리 배울 수 있습니다.  

하지만 일부 API는 이런 규칙을 살짝 벗어나기도 하므로, 처음 사용하는 API는 문서를 반드시 읽어야 합니다.

### 4.2.1 메서드

HTTP를 통해 웹 서버에 정보를 요청하는 방법은 다음 네 가지입니다.

- **GET**
- **POST**
- **PUT**
- **DELETE**

**GET** 은 브라우저의 주소 표시줄을 통해 웹사이트에 방문할 때 쓰는 방법입니다. http://freegeoip.net/json/50.78.253.58 을 호출할 때도 GET 메서드를 씁니다. GET 은 웹서버에 정보를 요청할 때 쓰는 방법이라고 생각해도 됩니다.

**POST** 는 폼을 작성하거나, 서버에 있는 스크립트에 정보를 보낼 때 사용합니다. 웹사이트에 로그인할 때마다 사용자 이름과 암호화된 비밀번호를 보낼 때도 POST 요청을 사용합니다. API에 POST 요청을 보내는 건 그 정보를 데이터베이스에 저장하라고 요청을 하는 겁니다.

**PUT** 은 웹사이트에서는 널리 쓰이지 않지만 API에는 가끔 쓰입니다. PUT 요청은 객체나 정보를 업데이트할 때 사용합니다. 예를 들어 새 사용자를 등록할 때는 POST 요청을, 사용자의 이메일 주소를 업데이트할 떄는 PUT 요청을 쓰는 API가 있을 수 있습니다.

> 대부분의 API가 정보를 업데이트할 때도 POST 요청을 사용합니다. 새 항목을 만드는 것인지, 기존 항목을 업데이트하는 것인지 구분하는 방법은 API 요청이 어떻게 만들어졌느냐에 달려 있습니다. 하지만 그 차이를 알아둬서 나쁜 건 없고, 널리 쓰이는 API 중에는 PUT 요청을 사용하는 API도 있습니다.

**DELETE** 는 문자 그대로 어떤 객채를 삭제할 때 사용합니다. 예를 들어 http://myapi.com/user/23 에 DELETE 요청을 보낸다면 그 API는 ID가 23인 사용자를 삭제할 겁니다. 무작위 사용자가 데이터베이스에서 정보를 제거하면 안되므로, 주로 정보의 배포가 목적인 공용 API에서 DELETE 메서드를 쓰는 경우는 별로 없습니다. 하지만 PUT 메서드와 마찬가지로 알아둬서 바쁠건 없습니다.

HTTP 명세에는 다른 HTTP 메서드도 많이 정의되어 있지만, 위 4 가지만 주로 사용합니다.

### 4.2.2 인증

인증을 전혀 사용하지 않는, 즉 애플리케이션에 등록하지 않고도 자유롭게 호출할 수 있는 API도 있지만 최신 API는 어떤 형태로든 인증을 해야 사용할 수 있습니다.

호출 횟수에 따라 비용을 청구하기 위해 인증을 요구하는 API도 있고, 월간 구독 개념으로 서비스를 제공하는 API도 있습니다. 초당, 시간당, 하루당 몇 회로 호출 숫자를 제한하기 위해 인증을 사용하는 곳도 있고, 사용자에 따라 특정 정보에의 접근을 제한하거나 API 호출 타입을 제한하기 위해 인증을 사용하는 곳도 있습니다. 제한 목적이 아니라 마케팅 목적으로 사용자가 무엇을 호출하는지 기록하려고 인증을 요구하는 곳도 있습니다.  

API 인증은 일반적으로 일종의 토큰을 사용하며 API를 호출할 때마다 이 토큰이 웹 서버에 전송됩니다. 사용자가 등록할 때 토큰을 제공하고 영구적으로 쓰는 곳도 있고(보통 높은 수준의 보안이 필요하지 않은 곳), 자주 바뀌며 사용자 이름과 비밀번호 조합에 따라 서버에서 받아오게 하는 곳도 있습니다.  

예를 들어 에코 네스트(Echo Nest) API에 건스 앤 로지스의 노래 목록을 오청하려면 다음과 같이 합니다.

`http://developer/echonest.com/api/v4/artist/songs?api_key=[your api key]&name=guns%20n%27%20reses&format=json&start=0&results=10`

이 요청은 API에 등록할 때 받은 `api_key` 값을 서버에 보내서 서버가 요청자를 라이언 미첼이라고 인식하고, json 데이터를 요청자에게 보냅니다.  

토큰은 요청 자체의 URL에 넣어서 보낼 수도 있고, 요청 헤더에서 쿠키를 통해 보낼 수고 있습니다. 이전에 다룬 urllib 패키지를 통해 보낼 수도 있습니다.

```python
token = "[your api key]"
webRequest = urllib.request.Request("http://myapi.com", headers={"token":token})
html = urlopen(webRequest)
```

## 4.3 응답

API에서 중요한 부분은 그 응답이 정형화되어 있다는 겁니다. 가장 널리 쓰이는 응답 타입은  **XML(Extensible Markup Language)** 과 **JSOM(JavaScript Object Notations)** 입니다.

몇 가지 중요한 이유로 최근에는 JSON 이 XML 보다 더 널리 쓰입니다. 먼저, JSON 파일은 일반적으로 디자인된 XML 파일보다 작습니다.

XML 데이터로   `<user><firstname>Ryan</firstname><lastname>Mitchell</lastname><username>Kludgist</username></user>`

98 글자인데, 같은 데이터를 JSON으로 나타내면 다음과 같습니다,

`{"user":{"firstname":"Ryan","lastname":"Mitchell","username":"Kludgist"}}`

73 글자이고, XML에 비해 36%만큼 작습니다.

물론 XML으로도 JSON과 같은 형식으로 만들 수도 있습니다.

`<user firstname="ryan" lastname="Mitchell" username="Kludgist"></user>`  

하지만 이런 형식은 중첩된 데이터를 깊숙이 탐색할 수 없으므로 나쁜 형식입니다. 그리고 JSON과 글자 수 차이도 많이 나지 않습니다.  

JSON이 빠르게 퍼진 이유에는 웹 기술의 발전도 있습니다. 과거에는 API를 받는 쪽에서도 PHP나 .NET 같은 서버쪽 스크립트를 쓰는 경우가 많았습니다. 요즘은 앵귤러나 백본 같은 프레임워크가 API 호출을 주고 받습니다. 서버 쪽 기술은 받는 데이터 형식에 다소 완고한 편입니다. 반면 백본 같은 자바스크립 라이브러리는 JSON을 더 선호합니다.  

### 4.3.1 API 호출

API 호출 문법은 API에 따라 크게 다르지만, 몇 가지 표준적이 부분도 존재합니다. GET 요청으로 데이터를 가져올 때, URL 경로는 데이터에 어떻게 찾아가는지를 나타내고 쿼리 매개변수는 일종의 필터 또는 검색에 사용할 추가 요청 구실을 합니다.

예를 들어 가상의 API에, ID가 1234인 사용자가 2014년 8월 한 달 동안 작성한 글을 요청한다면 다음과 비슷한 URL을 사용할 겁니다.  

`http://socialmediasite.com/user/1234/posts?from=08012014&to=08312014`

URL 경로에 API 버전, 원하는 데이터 형식, 기타 속성을 사용하는 API도 있습니다. 예를 들어 위 요청에 추가로 API 버전 4를 사용해서 JSON 형식으로 데이터를 요청한다고 합시다.

`http://socialmediasite.com/api/v4/json/user/1234/posts?from=08012014&to=08312014`  

API 버전과 데이터 형식을 매개변수로 받는 곳도 있습니다.

`http://socialmediasite.com/user/1234/posts?format=json&from=08012014&to=08312014`

## 4.4 에코 네스트

에코 네스트는 웹 스크레이퍼를 기반으로 움직이는 회사의 좋은 예입니다. 판도라처럼 음악으로 수익을 올리는 회사들은 음악을 분류하고 설명을 첨부하는 작업에 사람의 손이 필요하지만, 에코 네스트는 인공지능으로 블로그와 뉴스에서 스크랩한 정보를 음악가, 음악, 앨범으로 분류합니다.  

더 좋은 점은, 비상업적 용도로는 이 API를 무료로 사용할 수 있습니다. 물론 API 키는 필요하지만, 에코 네스트의 계정 생성 페이지(https://developer.echonest.com/account/register)에서 이름과 이메일 주소, 사용자 이름만 등록하면 키를 받을 수 있습니다.
> 현재는 대한민국은 지원하지 않습니다. 그래서 예제는 넘어갑니다.

## 4.5 트위터


### 4.5.1 시작하기

### 4.5.2 몇 가지 예제

## 4.6 구글 API

### 4.6.1 시작하기

### 4.6.2 몇 가지 예제

## 4.7 JSON 파싱

## 4.8 모든 것을 하나로

## 4.9 마치며
