---
layout: post
section-type: post
title: crawling - P2. 고급 스크레이핑 _ chap 14. 원격 스크레이핑
category: python
tags: [ 'python' ]
---

이번 챕터에서는 스크립트를 다른 컴퓨터, 또는 자신의 컴퓨터에서 다른 IP 주소를 사용해 실행하는 방법을 다룹니다.

## 14.1 원격 서버를 쓰는 이유

원격 서버는 웹 앱을 공개할 때 필수적이지만, 자신의 필요에 의해 만든 프로그램은 보통 로컬에서 실행됩니다. 원격 플랫폼을 사용하는 사람들이 그런 결정을 내리는 동기는 보통 두 가지입니다. 하나는 더 강력하고 유연한 환경이 필요해서이고, 다른 하나는 대체 IP 주소가 필요해서 입니다.

### 14.1.1 IP 주소 차단 방지

웹 스크레이퍼를 만들다 보면 무엇이든 속일 수 있다는 것을 알게 됩니다. 발신자 주소를 조작하여 이메일을 보낼 수도 있고, CLI에서 마우스를 움직일 수 있으며, 심지어 인터넷 익스플로러 5.0으로 사이트를 방문한 것처럼 속여서 사이트 관리를 멘붕으로 만들 수도 있습니다.  

단 하나 속일 수 없는 것은 IP 주소입니다.
> 기술적으로는 IP 주소도 속일 수 있습니다. 나가는 패킷을 위조하면 됩니다. 이는 분산형 서비스 거부 공격(DDOS)에서 사용하는 방법이며, 이걸 쓰면 공격자는 반환 패킷을 받지 못합니다.(받을 주소를 위조했으니까요) 하지만 웹스크레이퍼는 웹 서버의 응답을 바라고 하는 것이기 때문에 IP 주소는 속일 수 없는 것이라 할 수 있습니다.

스크레이퍼가 웹사이트에 접근하지 못하게 막는 노력의 대부분은 사람과 봇을 구별하는 것에 집중합니다. 봇을 막으려고 IP 주고까지 차단하는 건, 마치 농부가 농약 대신 밭을 불 태워버리는 것과 같습니다. 마지막 수단이긴 하지만, 말썽부리는 IP 주소에서 보내는 패킷을 모두 무시하는게 효율적인 수단인 것은 분명합니다. 하지만 이 방법에는 문제가 있습니다.

- IP 주소 접근 리스트를 관리하는건 매우 귀찮은 일입니다. 대형 웹사이트는 대부분 이런 리스트를 자동적으로 관리하는 프로그램을 사용하고 있지만(봇이 봇을 차단하네요...), 누군가는 가끔이라도 체크하거나 최소한 관찰이라도 하고 있어야 합니다.
- 서버는 패킷을 받을 때마다 그 패킷을 무시할지 받아들일지 리스트를 보고 판단해야 하므로, 각 주소에서 패킷을 받을 때마다 미미하지만 자원을 소비합니다. 주소와 패킷의 수를 곱하면 이 시간은 순식간에 늘어납니다. 처리 시간과 복잡성을 줄이기 위해, 공격자들이 밀집되어 있을 때 관리자들은 이들 IP 주소를 그룹으로 묶고 '이 범위에 있는 주소 256개를 모두 차단한다'같은 규칙을 만들곤 합니다. 여기서 세 번째 문제가 발생합니다.
- IP 주소 차단은 의도하지 않은 결과를 낳을 수 있습니다. IP 주소는 개인일 수도 있지만 공유기를 통해 전송된다면 IP 하나에 여럿 혹은 더 많은 사용자가 묶여 있을 수 있습니다. IP 하나를 차단했지만, 그로 인해 무고한 사용자(혹은 고객)까지 접속을 금지시킬 수 있습니다.

결점이 있음에도 불구하고, IP 주소 차단은 서버 관리자가 웹 스크레이퍼로 의심되는 무엇인가가 서버에 접근하지 못하게 할 때 많이 쓰이는 방법입니다.

### 14.1.2 이동성과 확장성

어떤 작업은 집에 있는 컴퓨터와 인터넷만으로 수행하기엔 너무 규모가 클 수도 있습니다. 웹사이트 하나에 그렇게 큰 부담을 싶지 않겠지만, 광범위한 사이트를 대상으로 데이터를 수집하다 보면 연결 대역폭과 저장 공간을 감당할 수 없을 때도 있습니다.

프로세서 자원을 많이 소모하는 작업을 다른 컴퓨터에 맡기면 집의 컴퓨터로는 더 중요한 작업을 할 수 있습니다. 컴퓨터의 전원이나 인터넷 연결에 신경 쓸 필요도 없습니다.  

애플리케이션이 컴퓨터 자원을 어마어마하게 소모하게 되어 아마존 임대 서버 하나로는 감당 할 수 없다면 **분산형 컴퓨팅** 을 알아보면 됩니다. 분산형 컴퓨팅은 여러 컴퓨터를 병렬로 연결해 한가지 작업을 수행하는 것입니다. 예를 들면, 컴퓨터 한 대가 한 사이트 집합에서 데이터를 수집하는 동안 다른 컴퓨터는 다른 사이트 집합에서 데이터를 수집하고, 두 컴퓨터는 수집된 데이터를 같은 데이터베이스에 저장하는 겁니다.  

누구든 구글 검색을 따라 할 수는 있지만, 구글 검색의 규모를 그대로 따라 할 수 있는 곳은 거의 없습니다. 분산형 컴퓨팅은 매우 방대한 분야입니다. 하지만 원격 서버에서 애플리케이션을 실행하는 것을 필수적인 첫 단계입니다.

## 14.2 토르

**토르** 로 더 잘 알려진 어니언 라우터(The Onion Router) 네트워크는 자발적으로 참여하는 서버로 구성된 네트워크입니다. 트래픽은 여러 계층으로 구성된 서버들을 거치며(이러한 점 때문에 양파입니다.) 어디서 출발했는지 알 수 없게 됩니다. 데이터는 네트워크에 들어 가기 전에 암호화되므로 특정 서버가 중간에서 감청되더라도 내용을 알 수 없습니다. 또한, 특정 서버에서 들어오고 나가는 통신을 탈취하더라도 통신의 시작과 끝을 정확히 파악하려면 그 통신 경로에 있는 **모든 서버** 의 들어오고 나가는 통신에 대해 자세히 알아야 하는데, 이건 거의 불가능한 일입니다.  

> ### 토르 익명성의 한계
여기서 토르를 사용하는 이유는 IP 주소를 바꾸는 것이지, 완벽한 익명성을 보장하는 것이 아닙니다. 토르의 트래픽 익명화에 대해 강점과 한계를 알아 보길 권장합니다.  
토르를 사용하면 IP 주소를 추적당하지 않긴 하지만, 웹 서버와 공유한 정보 자체에 당신을 노출할 단서가 있을 수 있습니다. 예를 들어 지메일 계정으로 로그인한 다음 구글 검색을 하면, 그 검색에서 당신의 정체가 드러날 수 있습니다.  
토르에 로그인하는 것만으로도 위협이 있을 수 있습니다. 2013년 12월, 하버드 학부생이 기말고사를 회피할 목적으로 토르 네트워크를 통해 익명 이메일 계정으로 대학을 공격한 일이 있었습니다. 하버드 IP 팀은 로그를 조사하여 그 공격이 이루어진 시간 동안 토르 네트워크에서 나간 트래픽은 단 하나의 컴퓨터에서 출발했다는 사실을 밝혀냈고 그 컴퓨터의 사용자로 등록된 학생을 알아냈습니다. IP 팀은 이 트래픽이 토르를 경유했다는 사실만 알아냈을 뿐 정확한 목적지를 찾아낼 수는 없었지만, 시간이 일치했고 그 시점에서 토르에 로그인 된 컴퓨터는 단 한 대였다는 사실만으로도 그 학생을 기소하기에는 충분했습니다.  
토르에 로그인한다고 해서 투명망토를 입는 것이 아니고, 인터넷에서 원하는 대로 할 수 있는 것도 아닙니다. 토르가 유용한 도구임은 분명하지만, 사용할 때는 충분히 책임감을 가지고 사용해야 합니다.

파이썬에서 토르를 사용하려면 따로 설치하고 실행해야 합니다. [토르 다운로드 페이지](https://www.torproject.org/download/download){:target="`_`blank"}에서 내려받아 설치하고, 실행해서 연결하기만 하면 됩니다. 토르를 사용하는 동안 인터넷 속도가 느려질 수도 있습니다. 패킷이 전 세계를 여러 번 왔다 갔다 하고 있을 수도 있기 때문입니다.

### 14.2.1 파이삭스

파이삭스(PySocks)는 프록시 서버로 트래픽을 돌리는 매우 단순한 파이썬 모듈이며 토르와 함께 잘 동작합니다.

##### 설치

```
pip install pysocks
```

파이삭스 문서는 자세히 나오지는 않지만 매우 단순합니다. 이 코드를 실행하려면 토르 서비스가 반드시 포트 9150(기본포트)에서 실행 중이어야 합니다.

```python
import socks
import socket
from urllib.request import urlopen

socks.set_default_proxy(socks.SOCKS5, "localhost", 9150)
socket.socket = socks.socksocket
print(urlopen('http://icanhazip.com').read())
```
http://icanhazip.com 사이트는 서버에 연결된 클라이언트의 IP 주소만 표시하며 테스트에 유용하게 쓸 수 있습니다. 이 스크립트를 실행한 결과로 표시된 IP 주소는 자신의 원래 IP와 달라야 합니다.  

```
b'192.160.102.169\n'
```

셀레니움과 펜텀JS를 써서 토르를 사용한다면 파이삭스가 필요하지 않습니다. 토르가 실행 중 일 때 셀레니움에서 포트 9150을 사용하게 하는 `service_args` 매개변수를 사용하기만 하면 됩니다.

```python
from selenium import webdriver
service_args = [ '--proxy=localhost:9150', '--proxy-type=socks5', ]
driver = webdriver.PhantomJS(executable_path='[path to PhantomJS]', service_args=service_args)
driver.get("http://icanhazip.com")
print(driver.page_source)
driver.close()
```

이번에도 표시된 IP 주소는 원래 IP가 아니라 토르가 현재 사용 중인 IP 주소여야 합니다.

```
<html><head></head><body><pre style="word-wrap: break-word; white-space: pre-wrap;">2605:e200:d00c:c01d::7777
</pre></body></html>
```

## 14.3 원격 호스팅

### 14.3.1  웹사이트 호스트 계정에서 실행

### 14.3.2 클라우드에서 실행

## 14.4 추가 자료

## 14.5 미래를 향해
